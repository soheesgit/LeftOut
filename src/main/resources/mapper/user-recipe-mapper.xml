<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userRecipe">

    <!-- 레시피 생성 -->
    <insert id="save" parameterType="com.example.demo.TEST_001.dto.UserRecipeDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_recipe (
            user_id,
            title,
            description,
            ingredients,
            cooking_steps,
            preparation_time,
            cooking_time,
            servings,
            difficulty_level,
            main_image_path
        )
        VALUES (
            #{userId},
            #{title},
            #{description},
            #{ingredients},
            #{cookingSteps},
            #{preparationTime},
            #{cookingTime},
            #{servings},
            #{difficultyLevel},
            #{mainImagePath}
        )
    </insert>

    <!-- 레시피 조회 (ID로) -->
    <select id="findById" parameterType="long" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.ingredients,
            ur.cooking_steps,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            ur.updated_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        WHERE ur.id = #{id}
    </select>

    <!-- 레시피 조회 (ID + 좋아요 여부) -->
    <select id="findByIdWithLikeStatus" parameterType="map" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.ingredients,
            ur.cooking_steps,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            ur.updated_at,
            u.name AS authorName,
            u.username AS authorUsername,
            CASE WHEN rl.id IS NOT NULL THEN TRUE ELSE FALSE END AS isLiked
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        LEFT JOIN recipe_like rl ON ur.id = rl.recipe_id AND rl.user_id = #{userId}
        WHERE ur.id = #{id}
    </select>

    <!-- 전체 레시피 목록 조회 -->
    <select id="findAll" parameterType="map" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        <where>
            <if test="search != null and search != ''">
                AND (ur.title LIKE CONCAT('%', #{search}, '%')
                OR ur.description LIKE CONCAT('%', #{search}, '%')
                OR ur.ingredients LIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
        ORDER BY ur.created_at DESC
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 사용자별 레시피 목록 -->
    <select id="findByUserId" parameterType="long" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        WHERE ur.user_id = #{userId}
        ORDER BY ur.created_at DESC
    </select>

    <!-- 좋아요한 레시피 목록 -->
    <select id="findLikedRecipes" parameterType="long" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        JOIN recipe_like rl ON ur.id = rl.recipe_id
        WHERE rl.user_id = #{userId}
        ORDER BY rl.created_at DESC
    </select>

    <!-- 레시피 수정 -->
    <update id="update" parameterType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        UPDATE user_recipe
        SET
            title = #{title},
            description = #{description},
            ingredients = #{ingredients},
            cooking_steps = #{cookingSteps},
            preparation_time = #{preparationTime},
            cooking_time = #{cookingTime},
            servings = #{servings},
            difficulty_level = #{difficultyLevel}
            <if test="mainImagePath != null">
                , main_image_path = #{mainImagePath}
            </if>
        WHERE id = #{id}
    </update>

    <!-- 레시피 삭제 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM user_recipe
        WHERE id = #{id}
    </delete>

    <!-- 조회수 증가 -->
    <update id="incrementViewCount" parameterType="long">
        UPDATE user_recipe
        SET view_count = view_count + 1
        WHERE id = #{id}
    </update>

    <!-- 좋아요 수 업데이트 -->
    <update id="updateLikeCount" parameterType="long">
        UPDATE user_recipe
        SET like_count = (SELECT COUNT(*) FROM recipe_like WHERE recipe_id = #{recipeId})
        WHERE id = #{recipeId}
    </update>

    <!-- 댓글 수 업데이트 -->
    <update id="updateCommentCount" parameterType="long">
        UPDATE user_recipe
        SET comment_count = (SELECT COUNT(*) FROM recipe_comment WHERE recipe_id = #{recipeId})
        WHERE id = #{recipeId}
    </update>

    <!-- 전체 레시피 수 조회 -->
    <select id="countAll" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM user_recipe ur
        <where>
            <if test="search != null and search != ''">
                AND (ur.title LIKE CONCAT('%', #{search}, '%')
                OR ur.description LIKE CONCAT('%', #{search}, '%')
                OR ur.ingredients LIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
    </select>

</mapper>
