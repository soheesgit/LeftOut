<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userRecipe">

    <!-- 레시피 생성 -->
    <insert id="save" parameterType="com.example.demo.TEST_001.dto.UserRecipeDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_recipe (
            user_id,
            title,
            description,
            ingredients,
            cooking_steps,
            preparation_time,
            cooking_time,
            servings,
            difficulty_level,
            main_image_path
        )
        VALUES (
            #{userId},
            #{title},
            #{description},
            #{ingredients},
            #{cookingSteps},
            #{preparationTime},
            #{cookingTime},
            #{servings},
            #{difficultyLevel},
            #{mainImagePath}
        )
    </insert>

    <!-- 레시피 조회 (ID로) -->
    <select id="findById" parameterType="long" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.ingredients,
            ur.cooking_steps,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            ur.updated_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        WHERE ur.id = #{id}
    </select>

    <!-- 레시피 조회 (ID + 좋아요 여부) -->
    <select id="findByIdWithLikeStatus" parameterType="map" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.ingredients,
            ur.cooking_steps,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            ur.updated_at,
            u.name AS authorName,
            u.username AS authorUsername,
            CASE WHEN rl.id IS NOT NULL THEN TRUE ELSE FALSE END AS isLiked
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        LEFT JOIN recipe_like rl ON ur.id = rl.recipe_id AND rl.user_id = #{userId}
        WHERE ur.id = #{id}
    </select>

    <!-- 전체 레시피 목록 조회 -->
    <select id="findAll" parameterType="map" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        <where>
            <if test="search != null and search != ''">
                AND (ur.title LIKE CONCAT('%', #{search}, '%')
                OR ur.description LIKE CONCAT('%', #{search}, '%')
                OR ur.ingredients LIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
        ORDER BY ur.created_at DESC
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 사용자별 레시피 목록 -->
    <select id="findByUserId" parameterType="long" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        WHERE ur.user_id = #{userId}
        ORDER BY ur.created_at DESC
    </select>

    <!-- 좋아요한 레시피 목록 -->
    <select id="findLikedRecipes" parameterType="long" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            ur.id,
            ur.user_id,
            ur.title,
            ur.description,
            ur.preparation_time,
            ur.cooking_time,
            ur.servings,
            ur.difficulty_level,
            ur.main_image_path,
            ur.view_count,
            ur.like_count,
            ur.comment_count,
            ur.created_at,
            u.name AS authorName,
            u.username AS authorUsername
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        JOIN recipe_like rl ON ur.id = rl.recipe_id
        WHERE rl.user_id = #{userId}
        ORDER BY rl.created_at DESC
    </select>

    <!-- 레시피 수정 -->
    <update id="update" parameterType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        UPDATE user_recipe
        SET
            title = #{title},
            description = #{description},
            ingredients = #{ingredients},
            cooking_steps = #{cookingSteps},
            preparation_time = #{preparationTime},
            cooking_time = #{cookingTime},
            servings = #{servings},
            difficulty_level = #{difficultyLevel}
            <if test="mainImagePath != null">
                , main_image_path = #{mainImagePath}
            </if>
        WHERE id = #{id}
    </update>

    <!-- 레시피 삭제 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM user_recipe
        WHERE id = #{id}
    </delete>

    <!-- 조회수 증가 -->
    <update id="incrementViewCount" parameterType="long">
        UPDATE user_recipe
        SET view_count = view_count + 1
        WHERE id = #{id}
    </update>

    <!-- 좋아요 수 업데이트 -->
    <update id="updateLikeCount" parameterType="long">
        UPDATE user_recipe
        SET like_count = (SELECT COUNT(*) FROM recipe_like WHERE recipe_id = #{recipeId})
        WHERE id = #{recipeId}
    </update>

    <!-- 댓글 수 업데이트 -->
    <update id="updateCommentCount" parameterType="long">
        UPDATE user_recipe
        SET comment_count = (SELECT COUNT(*) FROM recipe_comment WHERE recipe_id = #{recipeId})
        WHERE id = #{recipeId}
    </update>

    <!-- 전체 레시피 수 조회 (사용자 작성 레시피만) -->
    <select id="countAll" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM user_recipe ur
        JOIN users u ON ur.user_id = u.id
        <where>
            <if test="search != null and search != ''">
                AND (ur.title LIKE CONCAT('%', #{search}, '%')
                OR ur.description LIKE CONCAT('%', #{search}, '%')
                OR ur.ingredients LIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
    </select>

    <!-- ========================================= -->
    <!-- API 레시피 통합용 쿼리                      -->
    <!-- ========================================= -->

    <!-- API 레시피 저장 -->
    <insert id="saveApiRecipe" parameterType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        INSERT INTO user_recipe (
            source, rcp_seq, title, rcp_way2, rcp_pat2, rcp_parts_dtls,
            info_wgt, info_eng, info_car, info_pro, info_fat, info_na,
            rcp_na_tip, hash_tag, att_file_no_main, att_file_no_mk,
            manual01, manual02, manual03, manual04, manual05,
            manual06, manual07, manual08, manual09, manual10,
            manual11, manual12, manual13, manual14, manual15,
            manual16, manual17, manual18, manual19, manual20,
            manual_img01, manual_img02, manual_img03, manual_img04, manual_img05,
            manual_img06, manual_img07, manual_img08, manual_img09, manual_img10,
            manual_img11, manual_img12, manual_img13, manual_img14, manual_img15,
            manual_img16, manual_img17, manual_img18, manual_img19, manual_img20,
            parsed_ingredients, ingredient_count
        ) VALUES (
            'api', #{rcpSeq}, #{title}, #{rcpWay2}, #{rcpPat2}, #{rcpPartsDtls},
            #{infoWgt}, #{infoEng}, #{infoCar}, #{infoPro}, #{infoFat}, #{infoNa},
            #{rcpNaTip}, #{hashTag}, #{attFileNoMain}, #{attFileNoMk},
            #{manual01}, #{manual02}, #{manual03}, #{manual04}, #{manual05},
            #{manual06}, #{manual07}, #{manual08}, #{manual09}, #{manual10},
            #{manual11}, #{manual12}, #{manual13}, #{manual14}, #{manual15},
            #{manual16}, #{manual17}, #{manual18}, #{manual19}, #{manual20},
            #{manualImg01}, #{manualImg02}, #{manualImg03}, #{manualImg04}, #{manualImg05},
            #{manualImg06}, #{manualImg07}, #{manualImg08}, #{manualImg09}, #{manualImg10},
            #{manualImg11}, #{manualImg12}, #{manualImg13}, #{manualImg14}, #{manualImg15},
            #{manualImg16}, #{manualImg17}, #{manualImg18}, #{manualImg19}, #{manualImg20},
            #{parsedIngredients}, #{ingredientCount}
        )
    </insert>

    <!-- API 레시피 중복 체크 -->
    <select id="existsByRcpSeq" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_recipe
        WHERE rcp_seq = #{rcpSeq}
    </select>

    <!-- API 레시피 개수 조회 -->
    <select id="countApiRecipes" resultType="int">
        SELECT COUNT(*)
        FROM user_recipe
        WHERE source = 'api'
    </select>

    <!-- API 레시피 전체 조회 (필터링/검색 포함) - 성능 최적화: 필요한 컬럼만 -->
    <select id="findApiRecipes" parameterType="map" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            id, source, rcp_seq, title, rcp_way2, rcp_pat2,
            info_eng, att_file_no_main, att_file_no_mk,
            parsed_ingredients, ingredient_count, created_at
        FROM user_recipe
        WHERE source = 'api'
        <if test="rcpWay2 != null and rcpWay2 != ''">
            AND rcp_way2 = #{rcpWay2}
        </if>
        <if test="rcpPat2 != null and rcpPat2 != ''">
            AND rcp_pat2 = #{rcpPat2}
        </if>
        <if test="searchRecipeName != null and searchRecipeName != ''">
            AND title LIKE CONCAT('%', #{searchRecipeName}, '%')
        </if>
        <if test="searchIngredient != null and searchIngredient != ''">
            AND rcp_parts_dtls LIKE CONCAT('%', #{searchIngredient}, '%')
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- API 레시피 조회 (사용자 식재료 필터링) - 매칭 가능성 있는 레시피만 조회 -->
    <select id="findApiRecipesWithIngredients" parameterType="map" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            id, source, rcp_seq, title, rcp_way2, rcp_pat2,
            info_eng, att_file_no_main, att_file_no_mk,
            parsed_ingredients, ingredient_count, created_at
        FROM user_recipe
        WHERE source = 'api'
        <if test="rcpWay2 != null and rcpWay2 != ''">
            AND rcp_way2 = #{rcpWay2}
        </if>
        <if test="rcpPat2 != null and rcpPat2 != ''">
            AND rcp_pat2 = #{rcpPat2}
        </if>
        <if test="searchRecipeName != null and searchRecipeName != ''">
            AND title LIKE CONCAT('%', #{searchRecipeName}, '%')
        </if>
        <if test="searchIngredient != null and searchIngredient != ''">
            AND rcp_parts_dtls LIKE CONCAT('%', #{searchIngredient}, '%')
        </if>
        <if test="ingredientNames != null and ingredientNames.size() > 0">
            AND (
                <foreach collection="ingredientNames" item="ingredient" separator=" OR ">
                    parsed_ingredients LIKE CONCAT('%', #{ingredient}, '%')
                </foreach>
            )
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- API 레시피 상세 조회 (rcp_seq로) -->
    <select id="findByRcpSeq" parameterType="string" resultType="com.example.demo.TEST_001.dto.UserRecipeDTO">
        SELECT
            id, source, rcp_seq, title, rcp_way2, rcp_pat2, rcp_parts_dtls,
            info_wgt, info_eng, info_car, info_pro, info_fat, info_na,
            rcp_na_tip, hash_tag, att_file_no_main, att_file_no_mk,
            manual01, manual02, manual03, manual04, manual05,
            manual06, manual07, manual08, manual09, manual10,
            manual11, manual12, manual13, manual14, manual15,
            manual16, manual17, manual18, manual19, manual20,
            manual_img01, manual_img02, manual_img03, manual_img04, manual_img05,
            manual_img06, manual_img07, manual_img08, manual_img09, manual_img10,
            manual_img11, manual_img12, manual_img13, manual_img14, manual_img15,
            manual_img16, manual_img17, manual_img18, manual_img19, manual_img20,
            view_count, like_count, comment_count, created_at
        FROM user_recipe
        WHERE rcp_seq = #{rcpSeq}
    </select>

</mapper>
