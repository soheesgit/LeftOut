<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ingredient">

    <!-- 식재료 목록 조회 (유통기한 임박순, active 상태만) -->
    <select id="getList" parameterType="long" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.user_id = #{userId}
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 카테고리별 식재료 목록 조회 -->
    <select id="getListByCategory" parameterType="map" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.user_id = #{userId} AND i.category_id = #{categoryId}
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 검색 및 필터링 식재료 목록 조회 -->
    <select id="getListWithFilter" parameterType="map" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.user_id = #{userId}
        <if test="categoryId != null and categoryId != 0">
            AND i.category_id = #{categoryId}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            AND i.ingredient_name LIKE CONCAT('%', #{searchKeyword}, '%')
        </if>
        <if test="storageLocation != null and storageLocation != ''">
            AND i.storage_location = #{storageLocation}
        </if>
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 식재료 상세 조회 -->
    <select id="detail" parameterType="map" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.ingredient_id = #{id} AND i.user_id = #{userId}
    </select>

    <!-- 식재료 추가 -->
    <insert id="save" parameterType="ingredient">
        INSERT INTO ingredient(user_id, ingredient_name, category_id, purchase_date, expiry_date, quantity, unit, memo, storage_location, status)
        VALUES (#{userId}, #{ingredientName}, #{categoryId}, #{purchaseDate}, #{expiryDate}, #{quantity}, #{unit}, #{memo}, #{storageLocation}, 'active')
    </insert>

    <!-- 식재료 수정 -->
    <update id="update" parameterType="ingredient">
        UPDATE ingredient
        SET ingredient_name = #{ingredientName},
            category_id = #{categoryId},
            purchase_date = #{purchaseDate},
            expiry_date = #{expiryDate},
            quantity = #{quantity},
            unit = #{unit},
            memo = #{memo},
            storage_location = #{storageLocation}
        WHERE ingredient_id = #{ingredientId} AND user_id = #{userId}
    </update>

    <!-- 식재료 소비 완료 처리 -->
    <update id="markAsConsumed" parameterType="map">
        UPDATE ingredient
        SET status = 'consumed',
            consume_date = CURDATE()
        WHERE ingredient_id = #{id} AND user_id = #{userId}
    </update>

    <!-- 식재료 완전 삭제 -->
    <delete id="delete" parameterType="map">
        DELETE FROM ingredient
        WHERE ingredient_id = #{id} AND user_id = #{userId}
    </delete>

    <!-- 카테고리별 식재료 개수 조회 (삭제 검증용) -->
    <select id="countByCategoryId" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM ingredient
        WHERE category_id = #{categoryId} AND status = 'active'
    </select>

    <!-- 식재료 폐기 처리 -->
    <update id="markAsDiscarded" parameterType="map">
        UPDATE ingredient
        SET status = 'discarded',
            discard_date = CURDATE()
        WHERE ingredient_id = #{id} AND user_id = #{userId}
    </update>

    <!-- 통계: 기간별 폐기 통계 (일/주/월) -->
    <select id="getDiscardStatsByPeriod" parameterType="map" resultType="map">
        SELECT
            <choose>
                <when test="period == 'day'">
                    DATE(discard_date) as date,
                    COUNT(*) as count
                </when>
                <when test="period == 'week'">
                    DATE(DATE_SUB(discard_date, INTERVAL WEEKDAY(discard_date) DAY)) as date,
                    COUNT(*) as count
                </when>
                <when test="period == 'month'">
                    DATE_FORMAT(discard_date, '%Y-%m-01') as date,
                    COUNT(*) as count
                </when>
            </choose>
        FROM ingredient
        WHERE user_id = #{userId} AND status = 'discarded' AND discard_date IS NOT NULL
        <choose>
            <when test="period == 'day'">
                AND discard_date >= DATE_SUB(CURDATE(), INTERVAL #{limit} DAY)
            </when>
            <when test="period == 'week'">
                AND discard_date >= DATE_SUB(CURDATE(), INTERVAL #{limit} WEEK)
            </when>
            <when test="period == 'month'">
                AND discard_date >= DATE_SUB(CURDATE(), INTERVAL #{limit} MONTH)
            </when>
        </choose>
        GROUP BY date
        ORDER BY date ASC
    </select>

    <!-- 통계: 카테고리별 폐기 통계 -->
    <select id="getDiscardStatsByCategory" parameterType="map" resultType="map">
        SELECT
            c.category_name as categoryName,
            COUNT(*) as count
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.user_id = #{userId} AND i.status = 'discarded' AND i.discard_date IS NOT NULL
        <choose>
            <when test="period == 'day'">
                AND i.discard_date >= DATE_SUB(CURDATE(), INTERVAL #{limit} DAY)
            </when>
            <when test="period == 'week'">
                AND i.discard_date >= DATE_SUB(CURDATE(), INTERVAL #{limit} WEEK)
            </when>
            <when test="period == 'month'">
                AND i.discard_date >= DATE_SUB(CURDATE(), INTERVAL #{limit} MONTH)
            </when>
        </choose>
        GROUP BY c.category_name
        ORDER BY count DESC
    </select>

    <!-- 통계: 월별 소비/폐기 통계 -->
    <select id="getMonthlyConsumptionStats" parameterType="map" resultType="map">
        SELECT
            COALESCE(SUM(CASE WHEN status = 'consumed' THEN 1 ELSE 0 END), 0) as consumedCount,
            COALESCE(SUM(CASE WHEN status = 'discarded' THEN 1 ELSE 0 END), 0) as discardedCount
        FROM ingredient
        WHERE user_id = #{userId}
        AND (
            (status = 'consumed' AND YEAR(consume_date) = #{year} AND MONTH(consume_date) = #{month})
            OR
            (status = 'discarded' AND YEAR(discard_date) = #{year} AND MONTH(discard_date) = #{month})
        )
    </select>

    <!-- 통계: 보관 위치별 카테고리 분포 -->
    <select id="getStorageLocationDistribution" parameterType="long" resultType="map">
        SELECT
            i.storage_location as storageLocation,
            c.category_name as categoryName,
            COUNT(*) as count
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.user_id = #{userId} AND i.status = 'active'
        GROUP BY i.storage_location, c.category_name
        ORDER BY i.storage_location, count DESC
    </select>

    <!-- 통계: 현재 카테고리 구성 (active 식재료만) -->
    <select id="getCategoryComposition" parameterType="long" resultType="map">
        SELECT
            c.category_name as categoryName,
            COUNT(*) as count
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.user_id = #{userId} AND i.status = 'active'
        GROUP BY c.category_name
        ORDER BY count DESC
    </select>

</mapper>
