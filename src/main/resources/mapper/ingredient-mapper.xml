<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ingredient">

    <!-- 식재료 목록 조회 (유통기한 임박순, active 상태만) -->
    <select id="getList" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.memo,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active'
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 카테고리별 식재료 목록 조회 -->
    <select id="getListByCategory" parameterType="int" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.memo,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.category_id = #{categoryId}
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 식재료 상세 조회 -->
    <select id="detail" parameterType="int" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.memo,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.ingredient_id = #{id}
    </select>

    <!-- 식재료 추가 -->
    <insert id="save" parameterType="ingredient">
        INSERT INTO ingredient(ingredient_name, category_id, purchase_date, expiry_date, quantity, memo, status)
        VALUES (#{ingredientName}, #{categoryId}, #{purchaseDate}, #{expiryDate}, #{quantity}, #{memo}, 'active')
    </insert>

    <!-- 식재료 수정 -->
    <update id="update" parameterType="ingredient">
        UPDATE ingredient
        SET ingredient_name = #{ingredientName},
            category_id = #{categoryId},
            purchase_date = #{purchaseDate},
            expiry_date = #{expiryDate},
            quantity = #{quantity},
            memo = #{memo}
        WHERE ingredient_id = #{ingredientId}
    </update>

    <!-- 식재료 소비 완료 처리 -->
    <update id="markAsConsumed" parameterType="int">
        UPDATE ingredient
        SET status = 'consumed',
            consume_date = CURDATE()
        WHERE ingredient_id = #{id}
    </update>

    <!-- 식재료 완전 삭제 -->
    <delete id="delete" parameterType="int">
        DELETE FROM ingredient
        WHERE ingredient_id = #{id}
    </delete>

</mapper>
