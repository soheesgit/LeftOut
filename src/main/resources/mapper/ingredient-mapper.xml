<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ingredient">

    <!-- 식재료 목록 조회 (유통기한 임박순, active 상태만) -->
    <select id="getList" parameterType="long" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.user_id = #{userId}
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 카테고리별 식재료 목록 조회 -->
    <select id="getListByCategory" parameterType="map" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.user_id = #{userId} AND i.category_id = #{categoryId}
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 검색 및 필터링 식재료 목록 조회 -->
    <select id="getListWithFilter" parameterType="map" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.status = 'active' AND i.user_id = #{userId}
        <if test="categoryId != null and categoryId != 0">
            AND i.category_id = #{categoryId}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            AND i.ingredient_name LIKE CONCAT('%', #{searchKeyword}, '%')
        </if>
        <if test="storageLocation != null and storageLocation != ''">
            AND i.storage_location = #{storageLocation}
        </if>
        ORDER BY i.expiry_date ASC
    </select>

    <!-- 식재료 상세 조회 -->
    <select id="detail" parameterType="map" resultType="ingredient">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.category_id as categoryId,
            c.category_name as categoryName,
            i.purchase_date as purchaseDate,
            i.expiry_date as expiryDate,
            i.consume_date as consumeDate,
            i.quantity,
            i.unit,
            i.memo,
            i.storage_location as storageLocation,
            i.status,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        LEFT JOIN category c ON i.category_id = c.category_id
        WHERE i.ingredient_id = #{id} AND i.user_id = #{userId}
    </select>

    <!-- 식재료 추가 -->
    <insert id="save" parameterType="ingredient">
        INSERT INTO ingredient(user_id, ingredient_name, category_id, purchase_date, expiry_date, quantity, unit, memo, storage_location, status)
        VALUES (#{userId}, #{ingredientName}, #{categoryId}, #{purchaseDate}, #{expiryDate}, #{quantity}, #{unit}, #{memo}, #{storageLocation}, 'active')
    </insert>

    <!-- 식재료 수정 -->
    <update id="update" parameterType="ingredient">
        UPDATE ingredient
        SET ingredient_name = #{ingredientName},
            category_id = #{categoryId},
            purchase_date = #{purchaseDate},
            expiry_date = #{expiryDate},
            quantity = #{quantity},
            unit = #{unit},
            memo = #{memo},
            storage_location = #{storageLocation}
        WHERE ingredient_id = #{ingredientId} AND user_id = #{userId}
    </update>

    <!-- 식재료 소비 완료 처리 -->
    <update id="markAsConsumed" parameterType="map">
        UPDATE ingredient
        SET status = 'consumed',
            consume_date = CURDATE()
        WHERE ingredient_id = #{id} AND user_id = #{userId}
    </update>

    <!-- 식재료 완전 삭제 -->
    <delete id="delete" parameterType="map">
        DELETE FROM ingredient
        WHERE ingredient_id = #{id} AND user_id = #{userId}
    </delete>

    <!-- 카테고리별 식재료 개수 조회 (삭제 검증용) -->
    <select id="countByCategoryId" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM ingredient
        WHERE category_id = #{categoryId} AND status = 'active'
    </select>

</mapper>
