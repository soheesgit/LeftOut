<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="notification">

    <!-- 알림 저장 -->
    <insert id="save" parameterType="notification" useGeneratedKeys="true" keyProperty="notificationId">
        INSERT INTO notification(user_id, ingredient_id, type, title, message)
        VALUES (#{userId}, #{ingredientId}, #{type}, #{title}, #{message})
    </insert>

    <!-- 사용자별 알림 목록 조회 (최신순, 최근 30일) -->
    <select id="getListByUserId" parameterType="long" resultType="notification">
        SELECT
            n.notification_id as notificationId,
            n.user_id as userId,
            n.ingredient_id as ingredientId,
            n.type,
            n.title,
            n.message,
            n.is_read as isRead,
            n.created_at as createdAt,
            n.read_at as readAt,
            i.ingredient_name as ingredientName
        FROM notification n
        LEFT JOIN ingredient i ON n.ingredient_id = i.ingredient_id
        WHERE n.user_id = #{userId}
          AND n.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        ORDER BY n.created_at DESC
        LIMIT 50
    </select>

    <!-- 안읽은 알림 개수 조회 -->
    <select id="countUnread" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM notification
        WHERE user_id = #{userId} AND is_read = FALSE
    </select>

    <!-- 안읽은 알림 목록 조회 -->
    <select id="getUnreadByUserId" parameterType="long" resultType="notification">
        SELECT
            n.notification_id as notificationId,
            n.user_id as userId,
            n.ingredient_id as ingredientId,
            n.type,
            n.title,
            n.message,
            n.is_read as isRead,
            n.created_at as createdAt,
            i.ingredient_name as ingredientName
        FROM notification n
        LEFT JOIN ingredient i ON n.ingredient_id = i.ingredient_id
        WHERE n.user_id = #{userId} AND n.is_read = FALSE
        ORDER BY n.created_at DESC
    </select>

    <!-- 단일 알림 읽음 처리 -->
    <update id="markAsRead" parameterType="map">
        UPDATE notification
        SET is_read = TRUE, read_at = NOW()
        WHERE notification_id = #{notificationId} AND user_id = #{userId}
    </update>

    <!-- 전체 알림 읽음 처리 -->
    <update id="markAllAsRead" parameterType="long">
        UPDATE notification
        SET is_read = TRUE, read_at = NOW()
        WHERE user_id = #{userId} AND is_read = FALSE
    </update>

    <!-- 알림 삭제 -->
    <delete id="delete" parameterType="map">
        DELETE FROM notification
        WHERE notification_id = #{notificationId} AND user_id = #{userId}
    </delete>

    <!-- 오래된 알림 정리 (30일 이상) -->
    <delete id="deleteOldNotifications">
        DELETE FROM notification
        WHERE created_at &lt; DATE_SUB(NOW(), INTERVAL 30 DAY)
    </delete>

    <!-- 중복 알림 체크 (오늘 같은 타입/식재료 알림이 있는지) -->
    <select id="existsTodayNotification" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM notification
        WHERE user_id = #{userId}
          AND ingredient_id = #{ingredientId}
          AND type = #{type}
          AND DATE(created_at) = CURDATE()
    </select>

    <!-- 유통기한 임박 식재료 조회 (스케줄러용: D-3, D-1, D-Day) -->
    <select id="getExpiringIngredients" resultType="map">
        SELECT
            i.ingredient_id as ingredientId,
            i.user_id as userId,
            i.ingredient_name as ingredientName,
            i.expiry_date as expiryDate,
            DATEDIFF(i.expiry_date, CURDATE()) as daysUntilExpiry
        FROM ingredient i
        WHERE i.status = 'active'
          AND DATEDIFF(i.expiry_date, CURDATE()) IN (0, 1, 3)
        ORDER BY i.user_id, i.expiry_date
    </select>

</mapper>
