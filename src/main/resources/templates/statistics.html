<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/images/logo.png">
    <title>ì‹ì¬ë£Œ í†µê³„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        h1 {
            color: #333;
        }
        .nav-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        .btn-secondary {
            background-color: #008CBA;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }
        .period-toggle {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .period-toggle h3 {
            margin-top: 0;
            color: #333;
        }
        .period-btn {
            padding: 10px 25px;
            margin: 0 5px;
            border: 2px solid #4CAF50;
            background-color: white;
            color: #4CAF50;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .period-btn:hover {
            background-color: #f1f1f1;
        }
        .period-btn.active {
            background-color: #4CAF50;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-card.full-width {
            grid-column: 1 / -1;
        }
        .stats-card h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        .chart-container.tall {
            height: 400px;
        }
        .monthly-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }
        .summary-card.consumed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .summary-card.discarded {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .summary-card h3 {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        .summary-card .value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary-card .change {
            font-size: 14px;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 15px;
            display: inline-block;
        }
        .summary-card .change.positive {
            color: #90EE90;
        }
        .summary-card .change.negative {
            color: #FFB6C1;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Context Badge ìŠ¤íƒ€ì¼ */
        .context-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .context-badge .period-icon {
            margin-right: 8px;
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .stats-card.is-loading {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
        }
        .stats-card.is-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ì¹´ë“œ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .stats-card {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .stats-card.hidden {
            display: none;
        }

        /* TOP 5 í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .top-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .top-table th, .top-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .top-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .top-table tr:hover {
            background-color: #f5f5f5;
        }
        .top-table .rank {
            width: 50px;
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
        }
        .top-table .rank-1 { color: #FFD700; }
        .top-table .rank-2 { color: #C0C0C0; }
        .top-table .rank-3 { color: #CD7F32; }
        .top-table .category-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 12px;
        }
        .top-table .count {
            font-weight: bold;
            color: #f44336;
        }
        .no-data {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        /* íš¨ìœ¨ì„± ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .efficiency-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .efficiency-info.good {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .efficiency-info.warning {
            background-color: #fff3e0;
            color: #e65100;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š ì‹ì¬ë£Œ í†µê³„</h1>

    <!-- Navigation -->
    <div class="nav-section">
        <a href="/ingredient/list" class="btn btn-secondary">ğŸ“‹ ì‹ì¬ë£Œ ëª©ë¡</a>
        <a href="/ingredient/add" class="btn btn-primary">â• ì‹ì¬ë£Œ ì¶”ê°€</a>
        <a href="/category/manage" class="btn btn-secondary">ğŸ—‚ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</a>
        <a href="/" class="btn btn-secondary">ğŸ  ë©”ì¸ í˜ì´ì§€</a>
    </div>

    <!-- Period Toggle -->
    <div class="period-toggle">
        <h3>ğŸ“… ì¡°íšŒ ê¸°ê°„ ì„ íƒ</h3>
        <button class="period-btn active" data-period="day" onclick="changePeriod('day')">ì¼ ë‹¨ìœ„</button>
        <button class="period-btn" data-period="week" onclick="changePeriod('week')">ì£¼ ë‹¨ìœ„</button>
        <button class="period-btn" data-period="month" onclick="changePeriod('month')">ì›” ë‹¨ìœ„</button>
    </div>

    <!-- Context Badge -->
    <div class="context-badge" id="contextBadge">
        <span class="period-icon">ğŸ“Š</span>
        <span id="contextText">ìµœê·¼ 7ì¼ê°„ ë°ì´í„°ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤</span>
    </div>

    <!-- Monthly Summary Cards -->
    <div class="stats-card full-width" id="summaryCard">
        <h2 id="summaryTitle">ğŸ—“ï¸ ì´ë²ˆ ë‹¬ ìš”ì•½</h2>
        <div class="monthly-summary" id="monthlySummary">
            <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="stats-grid">
        <!-- Discard Stats by Period -->
        <div class="stats-card full-width" id="discardPeriodCard">
            <h2 id="discardPeriodTitle">ğŸ—‘ï¸ ì¼ë³„ íê¸° í†µê³„</h2>
            <div class="chart-container tall">
                <canvas id="discardPeriodChart"></canvas>
            </div>
        </div>

        <!-- Discard Stats by Category -->
        <div class="stats-card" id="discardCategoryCard">
            <h2 id="discardCategoryTitle">ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ íê¸° í†µê³„</h2>
            <div class="chart-container">
                <canvas id="discardCategoryChart"></canvas>
            </div>
        </div>

        <!-- ìì£¼ íê¸°ë˜ëŠ” ì‹ì¬ë£Œ TOP 5 (ì›” ë‹¨ìœ„ì—ì„œ ì¹´í…Œê³ ë¦¬ë³„ íê¸° í†µê³„ ì˜†ì— í‘œì‹œ) -->
        <div class="stats-card" id="topDiscardedCard">
            <h2>âš ï¸ ìì£¼ íê¸°ë˜ëŠ” ì‹ì¬ë£Œ TOP 5</h2>
            <div id="topDiscardedTable">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- Category Composition -->
        <div class="stats-card" id="categoryCompositionCard">
            <h2 id="categoryCompositionTitle">ğŸ¥— í˜„ì¬ ì¹´í…Œê³ ë¦¬ êµ¬ì„±</h2>
            <div class="chart-container">
                <canvas id="categoryCompositionChart"></canvas>
            </div>
        </div>

        <!-- ìš”ì¼ë³„ íê¸° íŒ¨í„´ (ì¼ ë‹¨ìœ„ì—ì„œ í˜„ì¬ ì¹´í…Œê³ ë¦¬ êµ¬ì„± ì˜†ì— í‘œì‹œ) -->
        <div class="stats-card" id="dayOfWeekCard">
            <h2>ğŸ“… ìš”ì¼ë³„ íê¸° íŒ¨í„´</h2>
            <div class="chart-container">
                <canvas id="dayOfWeekChart"></canvas>
            </div>
            <div id="dayOfWeekInfo" class="efficiency-info"></div>
        </div>

        <!-- Storage Location Distribution -->
        <div class="stats-card full-width" id="storageDistributionCard">
            <h2 id="storageDistributionTitle">ğŸ§Š ë³´ê´€ ìœ„ì¹˜ë³„ ì¹´í…Œê³ ë¦¬ ë¶„í¬</h2>
            <div class="chart-container">
                <canvas id="storageDistributionChart"></canvas>
            </div>
        </div>

        <!-- ì›”ë³„ íê¸°ìœ¨ ì¶”ì´ (ìƒˆë¡œìš´ ì°¨íŠ¸) -->
        <div class="stats-card full-width" id="discardRateCard">
            <h2>ğŸ“ˆ ì›”ë³„ íê¸°ìœ¨ ì¶”ì´</h2>
            <div class="chart-container tall">
                <canvas id="discardRateChart"></canvas>
            </div>
        </div>

        <!-- ë³´ê´€ ìœ„ì¹˜ë³„ íê¸°ìœ¨ (ìƒˆë¡œìš´ ì°¨íŠ¸) -->
        <div class="stats-card" id="storageEfficiencyCard">
            <h2>ğŸ§Š ë³´ê´€ ìœ„ì¹˜ë³„ íê¸°ìœ¨</h2>
            <div class="chart-container">
                <canvas id="storageEfficiencyChart"></canvas>
            </div>
            <div id="storageEfficiencyInfo" class="efficiency-info"></div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        let charts = {};
        let currentPeriod = 'day';
        let statsData = /*[[${stats}]]*/ {};

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];

        // ê¸°ê°„ë³„ ë¼ë²¨ ì„¤ì •
        const periodLabels = {
            day: {
                title: 'ìµœê·¼ 7ì¼',
                summaryTitle: 'ìµœê·¼ 7ì¼ ìš”ì•½',
                discardTitle: 'ì¼ë³„ íê¸° í†µê³„',
                categoryTitle: 'ì¹´í…Œê³ ë¦¬ë³„ íê¸° í†µê³„',
                compositionTitle: 'í˜„ì¬ ì¹´í…Œê³ ë¦¬ êµ¬ì„±',
                storageTitle: 'ë³´ê´€ ìœ„ì¹˜ë³„ ì¹´í…Œê³ ë¦¬ ë¶„í¬'
            },
            week: {
                title: 'ìµœê·¼ 12ì£¼',
                summaryTitle: 'ìµœê·¼ 12ì£¼ ìš”ì•½',
                discardTitle: 'ì£¼ë³„ íê¸° í†µê³„',
                categoryTitle: 'ì¹´í…Œê³ ë¦¬ë³„ íê¸° í†µê³„',
                compositionTitle: 'í˜„ì¬ ì¹´í…Œê³ ë¦¬ êµ¬ì„±',
                storageTitle: 'ë³´ê´€ ìœ„ì¹˜ë³„ ì¹´í…Œê³ ë¦¬ ë¶„í¬'
            },
            month: {
                title: 'ìµœê·¼ 12ê°œì›”',
                summaryTitle: 'ì´ë²ˆ ë‹¬ ìš”ì•½',
                discardTitle: 'ì›”ë³„ íê¸° í†µê³„',
                categoryTitle: 'ì¹´í…Œê³ ë¦¬ë³„ íê¸° í†µê³„',
                compositionTitle: 'í˜„ì¬ ì¹´í…Œê³ ë¦¬ êµ¬ì„±',
                storageTitle: 'ë³´ê´€ ìœ„ì¹˜ë³„ ì¹´í…Œê³ ë¦¬ ë¶„í¬'
            }
        };

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateAllCharts(statsData);

            // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ì¼ ë‹¨ìœ„)
            updateCardTitles('day');
            updateCardVisibility('day');
            updateContextBadge('day');
        });

        function changePeriod(period) {
            currentPeriod = period;

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');

            // ì œëª© ì—…ë°ì´íŠ¸
            updateCardTitles(period);

            // ì»´í¬ë„ŒíŠ¸ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
            updateCardVisibility(period);

            // Context Badge ì—…ë°ì´íŠ¸
            updateContextBadge(period);

            // ë°ì´í„° ê°±ì‹ 
            fetchStatistics(period);
        }

        function updateCardTitles(period) {
            const labels = periodLabels[period];
            document.getElementById('summaryTitle').textContent = 'ğŸ—“ï¸ ' + labels.summaryTitle;
            document.getElementById('discardPeriodTitle').textContent = 'ğŸ—‘ï¸ ' + labels.discardTitle;
            document.getElementById('discardCategoryTitle').textContent = 'ğŸ“‚ ' + labels.categoryTitle;
            document.getElementById('categoryCompositionTitle').textContent = 'ğŸ¥— ' + labels.compositionTitle;
            document.getElementById('storageDistributionTitle').textContent = 'ğŸ§Š ' + labels.storageTitle;
        }

        // ì»´í¬ë„ŒíŠ¸ ê°€ì‹œì„± ê·œì¹™
        const cardVisibility = {
            day: {
                summaryCard: false,
                discardPeriodCard: true,
                discardCategoryCard: false,
                categoryCompositionCard: true,
                storageDistributionCard: true,
                // ìƒˆë¡œìš´ ì°¨íŠ¸ ê°€ì‹œì„±
                discardRateCard: false,
                storageEfficiencyCard: false,
                dayOfWeekCard: true,
                topDiscardedCard: false
            },
            week: {
                summaryCard: false,
                discardPeriodCard: true,
                discardCategoryCard: true,
                categoryCompositionCard: false,
                storageDistributionCard: false,
                // ìƒˆë¡œìš´ ì°¨íŠ¸ ê°€ì‹œì„±
                discardRateCard: false,
                storageEfficiencyCard: true,
                dayOfWeekCard: true,
                topDiscardedCard: false
            },
            month: {
                summaryCard: true,
                discardPeriodCard: true,
                discardCategoryCard: true,
                categoryCompositionCard: false,
                storageDistributionCard: false,
                // ìƒˆë¡œìš´ ì°¨íŠ¸ ê°€ì‹œì„±
                discardRateCard: true,
                storageEfficiencyCard: true,
                dayOfWeekCard: false,
                topDiscardedCard: true
            }
        };

        function updateCardVisibility(period) {
            const visibility = cardVisibility[period];

            // ê° ì¹´ë“œì˜ í‘œì‹œ/ìˆ¨ê¹€ ì„¤ì •
            document.getElementById('summaryCard').style.display = visibility.summaryCard ? 'block' : 'none';
            document.getElementById('discardPeriodCard').style.display = visibility.discardPeriodCard ? 'block' : 'none';
            document.getElementById('discardCategoryCard').style.display = visibility.discardCategoryCard ? 'block' : 'none';
            document.getElementById('categoryCompositionCard').style.display = visibility.categoryCompositionCard ? 'block' : 'none';
            document.getElementById('storageDistributionCard').style.display = visibility.storageDistributionCard ? 'block' : 'none';
            // ìƒˆë¡œìš´ ì°¨íŠ¸ ê°€ì‹œì„±
            document.getElementById('discardRateCard').style.display = visibility.discardRateCard ? 'block' : 'none';
            document.getElementById('storageEfficiencyCard').style.display = visibility.storageEfficiencyCard ? 'block' : 'none';
            document.getElementById('dayOfWeekCard').style.display = visibility.dayOfWeekCard ? 'block' : 'none';
            document.getElementById('topDiscardedCard').style.display = visibility.topDiscardedCard ? 'block' : 'none';
        }

        // Context Badge ì—…ë°ì´íŠ¸
        function updateContextBadge(period) {
            const contextText = document.getElementById('contextText');
            const now = new Date();

            if (period === 'day') {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 6);
                const startStr = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
                const endStr = `${endDate.getMonth() + 1}/${endDate.getDate()}`;
                contextText.textContent = `ìµœê·¼ 7ì¼ê°„ ë°ì´í„°ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤ (${startStr} ~ ${endStr})`;
            } else if (period === 'week') {
                const endMonth = now.getMonth() + 1;
                const startMonth = endMonth - 2 > 0 ? endMonth - 2 : endMonth - 2 + 12;
                contextText.textContent = `ìµœê·¼ 12ì£¼ê°„ ë°ì´í„°ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤ (ì•½ ${startMonth}ì›” ~ ${endMonth}ì›”)`;
            } else {
                contextText.textContent = `ìµœê·¼ 12ê°œì›”ê°„ ë°ì´í„°ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤ (${now.getFullYear()}ë…„)`;
            }
        }

        // ë¡œë”© ìƒíƒœ ê´€ë¦¬
        function setLoadingState(isLoading) {
            const cards = document.querySelectorAll('.stats-card');
            cards.forEach(card => {
                if (isLoading) {
                    card.classList.add('is-loading');
                } else {
                    card.classList.remove('is-loading');
                }
            });
        }

        function fetchStatistics(period) {
            setLoadingState(true);

            fetch(`/statistics/data?period=${period}`)
                .then(response => response.json())
                .then(data => {
                    updateAllCharts(data);
                })
                .catch(error => {
                    console.error('Error fetching statistics:', error);
                })
                .finally(() => {
                    setLoadingState(false);
                });
        }

        function initializeCharts() {
            // íê¸° í†µê³„ (ê¸°ê°„ë³„) - ë§‰ëŒ€ + ì„ í˜• ê·¸ë˜í”„
            const ctx1 = document.getElementById('discardPeriodChart').getContext('2d');
            charts.discardPeriod = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'íê¸° íšŸìˆ˜',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ì¹´í…Œê³ ë¦¬ë³„ íê¸° í†µê³„ - ë§‰ëŒ€ ê·¸ë˜í”„
            const ctx2 = document.getElementById('discardCategoryChart').getContext('2d');
            charts.discardCategory = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'íê¸° íšŸìˆ˜',
                        data: [],
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ì¹´í…Œê³ ë¦¬ êµ¬ì„± - ë„ë„› ì°¨íŠ¸
            const ctx3 = document.getElementById('categoryCompositionChart').getContext('2d');
            charts.categoryComposition = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value}ê°œ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // ë³´ê´€ ìœ„ì¹˜ë³„ ë¶„í¬ - ë§‰ëŒ€ ê·¸ë˜í”„ (ê·¸ë£¹í™”)
            const ctx4 = document.getElementById('storageDistributionChart').getContext('2d');
            charts.storageDistribution = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ì›”ë³„ íê¸°ìœ¨ ì¶”ì´ - ë¼ì¸ ì°¨íŠ¸
            const ctx5 = document.getElementById('discardRateChart').getContext('2d');
            charts.discardRate = new Chart(ctx5, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'íê¸°ìœ¨ (%)',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `íê¸°ìœ¨: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // ë³´ê´€ ìœ„ì¹˜ë³„ íê¸°ìœ¨ - ë§‰ëŒ€ ì°¨íŠ¸
            const ctx7 = document.getElementById('storageEfficiencyChart').getContext('2d');
            charts.storageEfficiency = new Chart(ctx7, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'íê¸°ìœ¨ (%)',
                        data: [],
                        backgroundColor: ['#36A2EB', '#4BC0C0', '#FF9F40'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `íê¸°ìœ¨: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // ìš”ì¼ë³„ íê¸° íŒ¨í„´ - ë§‰ëŒ€ ì°¨íŠ¸
            const ctx8 = document.getElementById('dayOfWeekChart').getContext('2d');
            charts.dayOfWeek = new Chart(ctx8, {
                type: 'bar',
                data: {
                    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                    datasets: [{
                        label: 'íê¸° íšŸìˆ˜',
                        data: [],
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateAllCharts(data) {
            updatePeriodCharts(data);
            updateMonthlyStats(data.monthlyStats);
            updateCategoryComposition(data.categoryComposition);
            updateStorageDistribution(data.storageDistribution);
            // ìƒˆë¡œìš´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateDiscardRateChart(data.monthlyDiscardRate);
            updateStorageEfficiencyChart(data.storageEfficiency);
            updateDayOfWeekChart(data.discardPatternByDayOfWeek);
            updateTopDiscardedTable(data.topDiscardedIngredients);
        }

        function updatePeriodCharts(data) {
            // íê¸° ê¸°ê°„ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if (data.discardByPeriod && charts.discardPeriod) {
                const labels = data.discardByPeriod.map(item => {
                    const date = new Date(item.date);
                    if (currentPeriod === 'day') {
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    } else if (currentPeriod === 'week') {
                        return `${date.getMonth() + 1}/${date.getDate()} ì£¼`;
                    } else {
                        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    }
                });
                const counts = data.discardByPeriod.map(item => item.count);

                charts.discardPeriod.data.labels = labels;
                charts.discardPeriod.data.datasets[0].data = counts;
                charts.discardPeriod.update();
            }

            // ì¹´í…Œê³ ë¦¬ë³„ íê¸° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if (data.discardByCategory && charts.discardCategory) {
                const labels = data.discardByCategory.map(item => item.categoryName || 'ê¸°íƒ€');
                const counts = data.discardByCategory.map(item => item.count);

                charts.discardCategory.data.labels = labels;
                charts.discardCategory.data.datasets[0].data = counts;
                charts.discardCategory.update();
            }
        }

        function updateMonthlyStats(monthlyStats) {
            if (!monthlyStats) return;

            const current = monthlyStats.currentMonth;
            const changes = monthlyStats.changes;

            const html = `
                <div class="summary-card consumed">
                    <h3>ì†Œë¹„í•œ ì‹ì¬ë£Œ</h3>
                    <div class="value">${current.consumedCount}ê°œ</div>
                    <div class="change ${changes.consumedChange >= 0 ? 'positive' : 'negative'}">
                        ${changes.consumedChange >= 0 ? 'â–²' : 'â–¼'}
                        ${Math.abs(changes.consumedChange)}ê°œ
                        (${changes.consumedChangePercent >= 0 ? '+' : ''}${changes.consumedChangePercent}%)
                        <br>ì „ì›” ëŒ€ë¹„
                    </div>
                </div>
                <div class="summary-card discarded">
                    <h3>íê¸°í•œ ì‹ì¬ë£Œ</h3>
                    <div class="value">${current.discardedCount}ê°œ</div>
                    <div class="change ${changes.discardedChange <= 0 ? 'positive' : 'negative'}">
                        ${changes.discardedChange >= 0 ? 'â–²' : 'â–¼'}
                        ${Math.abs(changes.discardedChange)}ê°œ
                        (${changes.discardedChangePercent >= 0 ? '+' : ''}${changes.discardedChangePercent}%)
                        <br>ì „ì›” ëŒ€ë¹„
                    </div>
                </div>
            `;

            document.getElementById('monthlySummary').innerHTML = html;
        }

        function updateCategoryComposition(data) {
            if (!data || data.length === 0) {
                charts.categoryComposition.data.labels = ['ë°ì´í„° ì—†ìŒ'];
                charts.categoryComposition.data.datasets[0].data = [1];
                charts.categoryComposition.update();
                return;
            }

            const labels = data.map(item => item.categoryName || 'ê¸°íƒ€');
            const counts = data.map(item => item.count);

            charts.categoryComposition.data.labels = labels;
            charts.categoryComposition.data.datasets[0].data = counts;
            charts.categoryComposition.update();
        }

        function updateStorageDistribution(data) {
            if (!data) return;

            // ë³´ê´€ ìœ„ì¹˜ë³„ ë°ì´í„°ë¥¼ ê·¸ë£¹í™”ëœ ë§‰ëŒ€ ì°¨íŠ¸ë¡œ í‘œì‹œ
            const locations = Object.keys(data);
            const allCategories = new Set();

            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘
            locations.forEach(location => {
                data[location].categories.forEach(cat => {
                    allCategories.add(cat.categoryName);
                });
            });

            const categoryArray = Array.from(allCategories);
            const datasets = categoryArray.map((category, index) => {
                return {
                    label: category,
                    data: locations.map(location => {
                        const cat = data[location].categories.find(c => c.categoryName === category);
                        return cat ? cat.count : 0;
                    }),
                    backgroundColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });

            charts.storageDistribution.data.labels = locations.map(loc => {
                if (loc === 'ëƒ‰ì¥') return 'â„ï¸ ëƒ‰ì¥';
                if (loc === 'ëƒ‰ë™') return 'ğŸ§Š ëƒ‰ë™';
                if (loc === 'ì‹¤ì˜¨') return 'ğŸŒ¡ï¸ ì‹¤ì˜¨';
                return loc;
            });
            charts.storageDistribution.data.datasets = datasets;
            charts.storageDistribution.update();
        }

        // ì›”ë³„ íê¸°ìœ¨ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateDiscardRateChart(data) {
            if (!data || data.length === 0 || !charts.discardRate) return;

            const labels = data.map(item => item.month);
            const rates = data.map(item => item.discardRate);

            charts.discardRate.data.labels = labels;
            charts.discardRate.data.datasets[0].data = rates;
            charts.discardRate.update();
        }

        // ë³´ê´€ ìœ„ì¹˜ë³„ íê¸°ìœ¨ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateStorageEfficiencyChart(data) {
            if (!data || data.length === 0 || !charts.storageEfficiency) return;

            const locationOrder = ['ëƒ‰ì¥', 'ëƒ‰ë™', 'ì‹¤ì˜¨'];
            const orderedData = locationOrder.map(loc => {
                const found = data.find(item => item.storageLocation === loc);
                return found || { storageLocation: loc, discardRate: 0 };
            });

            const labels = orderedData.map(item => {
                if (item.storageLocation === 'ëƒ‰ì¥') return 'â„ï¸ ëƒ‰ì¥';
                if (item.storageLocation === 'ëƒ‰ë™') return 'ğŸ§Š ëƒ‰ë™';
                if (item.storageLocation === 'ì‹¤ì˜¨') return 'ğŸŒ¡ï¸ ì‹¤ì˜¨';
                return item.storageLocation;
            });
            const rates = orderedData.map(item => item.discardRate);

            charts.storageEfficiency.data.labels = labels;
            charts.storageEfficiency.data.datasets[0].data = rates;
            charts.storageEfficiency.update();

            // íš¨ìœ¨ì„± ì •ë³´ ì—…ë°ì´íŠ¸
            const infoEl = document.getElementById('storageEfficiencyInfo');
            const bestStorage = orderedData.reduce((min, curr) =>
                curr.discardRate < min.discardRate ? curr : min, orderedData[0]);
            const worstStorage = orderedData.reduce((max, curr) =>
                curr.discardRate > max.discardRate ? curr : max, orderedData[0]);

            if (worstStorage.discardRate > bestStorage.discardRate + 10) {
                infoEl.className = 'efficiency-info warning';
                infoEl.innerHTML = `ğŸ’¡ <b>${worstStorage.storageLocation}</b> ë³´ê´€ ì‹ì¬ë£Œì˜ íê¸°ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤. <b>${bestStorage.storageLocation}</b> ë³´ê´€ì´ ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤.`;
            } else {
                infoEl.className = 'efficiency-info good';
                infoEl.innerHTML = `âœ… ë³´ê´€ ìœ„ì¹˜ë³„ íê¸°ìœ¨ì´ ë¹„êµì  ê· ë“±í•©ë‹ˆë‹¤.`;
            }
        }

        // ìš”ì¼ë³„ íê¸° íŒ¨í„´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateDayOfWeekChart(data) {
            if (!data || data.length === 0 || !charts.dayOfWeek) return;

            const counts = data.map(item => item.count);

            charts.dayOfWeek.data.datasets[0].data = counts;
            charts.dayOfWeek.update();

            // íŒ¨í„´ ì •ë³´ ì—…ë°ì´íŠ¸
            const infoEl = document.getElementById('dayOfWeekInfo');
            const maxCount = Math.max(...counts);
            const maxDayIndex = counts.indexOf(maxCount);
            const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

            if (maxCount > 0) {
                infoEl.className = 'efficiency-info warning';
                infoEl.innerHTML = `ğŸ’¡ <b>${dayNames[maxDayIndex]}ìš”ì¼</b>ì— íê¸°ê°€ ì§‘ì¤‘ë©ë‹ˆë‹¤ (${maxCount}íšŒ).`;
            } else {
                infoEl.className = 'efficiency-info good';
                infoEl.innerHTML = `âœ… ìµœê·¼ 12ì£¼ê°„ íê¸°ëœ ì‹ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.`;
            }
        }

        // TOP 5 íê¸° ì‹ì¬ë£Œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTopDiscardedTable(data) {
            const container = document.getElementById('topDiscardedTable');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="no-data">ìµœê·¼ 12ê°œì›”ê°„ íê¸°ëœ ì‹ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = `
                <table class="top-table">
                    <thead>
                        <tr>
                            <th class="rank">ìˆœìœ„</th>
                            <th>ì‹ì¬ë£Œëª…</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>íê¸° íšŸìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                const rankClass = item.rank <= 3 ? `rank-${item.rank}` : '';
                html += `
                    <tr>
                        <td class="rank ${rankClass}">${item.rank}</td>
                        <td>${item.ingredientName}</td>
                        <td><span class="category-badge">${item.categoryName}</span></td>
                        <td class="count">${item.discardCount}íšŒ</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }
        /*]]>*/
    </script>
</body>
</html>
