<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëƒ‰í„¸ì´ - LeftOut</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #fff3e0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .brand {
            font-size: 32px;
            font-weight: bold;
            color: #2e7d32;
        }
        .brand-sub {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .user-info {
            text-align: right;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-info a {
            color: #2e7d32;
            text-decoration: none;
            font-weight: 500;
        }
        .user-info a:hover {
            text-decoration: underline;
        }
        .menu-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .menu-section h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8f5e9;
        }
        .menu-list {
            list-style: none;
        }
        .menu-list li {
            margin: 8px 0;
        }
        .menu-list a {
            display: block;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            transition: all 0.2s;
        }
        .menu-list a:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }
        .menu-list a.highlight-green {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
        }
        .menu-list a.highlight-green:hover {
            background: linear-gradient(135deg, #43A047, #4CAF50);
        }
        .menu-list a.highlight-orange {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            color: white;
        }
        .menu-list a.highlight-orange:hover {
            background: linear-gradient(135deg, #F57C00, #FF9800);
        }
        .menu-list a.highlight-red {
            background: linear-gradient(135deg, #FF6B6B, #FF8A80);
            color: white;
        }
        .menu-list a.highlight-red:hover {
            background: linear-gradient(135deg, #EF5350, #FF6B6B);
        }
        .random-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .random-section h3 {
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .random-section p {
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            margin-bottom: 15px;
        }
        .random-btn {
            display: inline-block;
            padding: 15px 30px;
            background: white;
            color: #667eea;
            border-radius: 30px;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .random-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .random-btn .dice {
            display: inline-block;
            animation: shake 2s ease-in-out infinite;
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            10% { transform: rotate(-10deg); }
            20% { transform: rotate(10deg); }
            30% { transform: rotate(0deg); }
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #888;
            font-size: 12px;
        }

        /* ì•Œë¦¼ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .notification-wrapper {
            display: inline-block;
            position: relative;
            margin-right: 15px;
            vertical-align: middle;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            padding: 5px 8px;
            font-size: 20px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .notification-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }

        .notification-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            margin-top: 8px;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            font-size: 14px;
        }

        .notification-header button {
            background: none;
            border: none;
            color: #2e7d32;
            cursor: pointer;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .notification-header button:hover {
            background: #e8f5e9;
        }

        .notification-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #fafafa;
        }

        .notification-item.unread {
            background: #e8f5e9;
        }

        .notification-item.unread:hover {
            background: #c8e6c9;
        }

        .notification-item .title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
            color: #333;
        }

        .notification-item .message {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .notification-item .time {
            font-size: 11px;
            color: #999;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            padding: 16px 50px 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            animation: slideInRight 0.3s ease-out;
            max-width: 350px;
        }

        .toast-notification.warning {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
        }

        .toast-notification.danger {
            background: linear-gradient(135deg, #f44336, #FF6B6B);
        }

        .toast-notification.show {
            display: block;
        }

        .toast-notification .toast-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .toast-notification .toast-message {
            font-size: 13px;
            line-height: 1.4;
        }

        .toast-notification .toast-close {
            position: absolute;
            top: 12px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
        }

        .toast-notification .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo">ğŸ§Š</div>
        <div class="brand">ëƒ‰í„¸ì´</div>
        <div class="brand-sub">LeftOut - ëƒ‰ì¥ê³  í„¸ê¸° í”„ë¡œì íŠ¸</div>
    </div>

    <div class="user-info">
        <span th:if="${session.loginUser != null}">
            <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
            <div class="notification-wrapper" id="notificationWrapper">
                <button class="notification-btn" id="notificationBtn" onclick="toggleNotificationPanel()">
                    <span>&#128276;</span>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>

                <!-- ì•Œë¦¼ íŒ¨ë„ -->
                <div class="notification-panel" id="notificationPanel" style="display: none;">
                    <div class="notification-header">
                        <span>ì•Œë¦¼</span>
                        <button onclick="markAllAsRead()">ëª¨ë‘ ì½ìŒ</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <strong th:text="${session.loginUser.name}">ì‚¬ìš©ì</strong>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
            | <a href="/settings/email">ì„¤ì •</a>
            | <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
        </span>
        <span th:if="${session.loginUser == null}">
            <a href="/login">ë¡œê·¸ì¸</a> | <a href="/signup">íšŒì›ê°€ì…</a>
        </span>
    </div>

    <div class="menu-section">
        <h3>ğŸ¥¬ ì‹ì¬ë£Œ ê´€ë¦¬</h3>
        <ul class="menu-list">
            <li><a href="/ingredient/list">ğŸ“‹ ë‚´ ëƒ‰ì¥ê³  ë³´ê¸°</a></li>
            <li><a href="/ingredient/quick-add" class="highlight-green">âš¡ ë¹ ë¥¸ ì¶”ê°€</a></li>
            <li><a href="/ingredient/add">ğŸ“ ìƒì„¸ ì¶”ê°€</a></li>
            <li><a href="/ingredient/ai-recognition">ğŸ¤– AI ì‹ì¬ë£Œ ì¸ì‹</a></li>
            <li><a href="/statistics">ğŸ“Š í†µê³„</a></li>
        </ul>
    </div>

    <!-- ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ëœë¤ ì¶”ì²œ -->
    <div class="random-section">
        <h3><span class="dice">ğŸ²</span> ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h3>
        <p>ê²°ì • ì¥ì•  í•´ê²°! ëœë¤ìœ¼ë¡œ ë ˆì‹œí”¼ë¥¼ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”</p>
        <a href="/recipe/random" class="random-btn">
            <span class="dice">ğŸ²</span> ëœë¤ ì¶”ì²œë°›ê¸°
        </a>
    </div>

    <div class="menu-section">
        <h3>âœï¸ ë ˆì‹œí”¼ ê²Œì‹œíŒ</h3>
        <ul class="menu-list">
            <li><a href="/recipe/list">ğŸ“š ì‚¬ìš©ì ë ˆì‹œí”¼</a></li>
            <li><a href="/recipe/my-recipes">ğŸ‘¤ ë‚´ ë ˆì‹œí”¼</a></li>
            <li><a href="/recipe/create" class="highlight-red">â• ìƒˆ ë ˆì‹œí”¼ ì‘ì„±</a></li>
            <li><a href="/recipe/liked-recipes">â¤ï¸ ì¢‹ì•„ìš”í•œ ë ˆì‹œí”¼</a></li>
        </ul>
    </div>

    <div class="footer">
        ëƒ‰í„¸ì´ LeftOut &copy; 2024
    </div>
</div>

<!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
<div id="toastNotification" class="toast-notification">
    <button class="toast-close" onclick="closeToast()">&times;</button>
    <div class="toast-title"></div>
    <div class="toast-message"></div>
</div>

<!-- ì•Œë¦¼ JavaScript (ë¡œê·¸ì¸ ì‹œì—ë§Œ) -->
<script th:if="${session.loginUser != null}">
    // SSE ì—°ê²°
    let eventSource = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;

    // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }

    // SSE ì—°ê²° ì‹œì‘
    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }

        eventSource = new EventSource('/notification/subscribe');

        // ì—°ê²° ì„±ê³µ
        eventSource.addEventListener('connect', function(e) {
            console.log('SSE ì—°ê²° ì„±ê³µ');
            reconnectAttempts = 0;
        });

        // ì•ˆì½ì€ ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        eventSource.addEventListener('unread-count', function(e) {
            updateBadge(parseInt(e.data));
        });

        // ìƒˆ ì•Œë¦¼ ìˆ˜ì‹ 
        eventSource.addEventListener('notification', function(e) {
            const notification = JSON.parse(e.data);
            console.log('ìƒˆ ì•Œë¦¼:', notification);

            // í† ìŠ¤íŠ¸ í‘œì‹œ
            showToastNotification(notification);

            // ë¸Œë¼ìš°ì € ì•Œë¦¼
            showBrowserNotification(notification);

            // ì•Œë¦¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadNotifications();
        });

        // ì—ëŸ¬ ì²˜ë¦¬
        eventSource.onerror = function(e) {
            console.error('SSE ì—°ê²° ì˜¤ë¥˜');
            eventSource.close();

            // ì¬ì—°ê²° ì‹œë„
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                console.log('ì¬ì—°ê²° ì‹œë„:', reconnectAttempts);
                setTimeout(connectSSE, 3000 * reconnectAttempts);
            }
        };
    }

    // ë±ƒì§€ ì—…ë°ì´íŠ¸
    function updateBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    // ì•Œë¦¼ íŒ¨ë„ í† ê¸€
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            loadNotifications();
        } else {
            panel.style.display = 'none';
        }
    }

    // ì•Œë¦¼ ëª©ë¡ ë¡œë“œ
    async function loadNotifications() {
        try {
            const response = await fetch('/notification/list');
            const data = await response.json();

            if (data.success) {
                renderNotifications(data.notifications);
                updateBadge(data.unreadCount);
            }
        } catch (error) {
            console.error('ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
    function renderNotifications(notifications) {
        const list = document.getElementById('notificationList');

        if (!notifications || notifications.length === 0) {
            list.innerHTML = '<div class="notification-empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        list.innerHTML = notifications.map(n => `
            <div class="notification-item ${n.isRead ? '' : 'unread'}"
                 onclick="handleNotificationClick(${n.notificationId}, ${n.ingredientId || 'null'})">
                <div class="title">${escapeHtml(n.title)}</div>
                <div class="message">${escapeHtml(n.message)}</div>
                <div class="time">${formatTime(n.createdAt)}</div>
            </div>
        `).join('');
    }

    // ì•Œë¦¼ í´ë¦­ ì²˜ë¦¬
    async function handleNotificationClick(notificationId, ingredientId) {
        // ì½ìŒ ì²˜ë¦¬
        await fetch(`/notification/read/${notificationId}`, { method: 'POST' });

        // ì‹ì¬ë£Œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        if (ingredientId && ingredientId !== 'null') {
            window.location.href = `/ingredient/detail/${ingredientId}`;
        } else {
            loadNotifications();
        }
    }

    // ëª¨ë‘ ì½ìŒ ì²˜ë¦¬
    async function markAllAsRead() {
        await fetch('/notification/read-all', { method: 'POST' });
        loadNotifications();
    }

    // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
    function showToastNotification(notification) {
        const toast = document.getElementById('toastNotification');

        // íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼
        toast.className = 'toast-notification';
        if (notification.type === 'EXPIRY_DDAY') {
            toast.classList.add('danger');
        } else if (notification.type === 'EXPIRY_D1') {
            toast.classList.add('warning');
        }

        toast.querySelector('.toast-title').textContent = notification.title;
        toast.querySelector('.toast-message').textContent = notification.message;
        toast.classList.add('show');

        // 5ì´ˆ í›„ ìë™ ë‹«ê¸°
        setTimeout(closeToast, 5000);
    }

    function closeToast() {
        const toast = document.getElementById('toastNotification');
        if (toast) {
            toast.classList.remove('show');
        }
    }

    // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
    function showBrowserNotification(notification) {
        if ('Notification' in window && Notification.permission === 'granted') {
            const n = new Notification(notification.title, {
                body: notification.message,
                icon: '/images/notification-icon.png',
                tag: 'expiry-' + notification.notificationId
            });

            n.onclick = function() {
                window.focus();
                if (notification.ingredientId) {
                    window.location.href = `/ingredient/detail/${notification.ingredientId}`;
                }
                n.close();
            };

            setTimeout(() => n.close(), 5000);
        }
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTime(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'ë°©ê¸ˆ ì „';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'ë¶„ ì „';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'ì‹œê°„ ì „';
        return Math.floor(diff / 86400000) + 'ì¼ ì „';
    }

    // íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        const wrapper = document.getElementById('notificationWrapper');
        const panel = document.getElementById('notificationPanel');
        if (wrapper && panel && !wrapper.contains(e.target)) {
            panel.style.display = 'none';
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        requestNotificationPermission();
        connectSSE();
        loadNotifications();
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ SSE ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
</script>
</body>
</html>